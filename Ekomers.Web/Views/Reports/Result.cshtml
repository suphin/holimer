@model Ekomers.Models.ReportVM


@{
    ViewData["Title"] = $"Rapor: {Model.Title}";
    var table = Model.Table;
     Layout = "_LayoutReport";
}

@section CSSection {
    <!--begin::Page Vendors Styles(used by this page)-->
    <link href="~/assets1/plugins/custom/datatables/datatables.bundle.css?v=7.0.5" rel="stylesheet" type="text/css" />
    <link href="~/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    <!--end::Page Vendors Styles-->
    <link href="~/assets0/css/style.bundle.min.css" rel="stylesheet" />
  
}

<!-- Yeniden post için gizli bir form -->
<form id="resultForm" asp-action="Run" method="post" class="d-none">
  <input type="hidden" name="ReportKey" value="@Model.ReportKey" />
  <input type="hidden" id="PageIndex" name="PageIndex" value="@Model.PageIndex" />
  <input type="hidden" name="PageSize"  value="@Model.PageSize" />

  @* Parametreleri geri gönder *@
  @foreach (var kv in Model.Parameters)
  {
      <input type="hidden" name="Parameters[@kv.Key]" value="@kv.Value" />
  }
</form>
<div class="card card-custom gutter-b example example-compact">
    <div class="card-header">
        <div class="card-title">
            <h3 class="card-label">
                @ViewData["Title"]
                <span class="d-block text-muted pt-2 font-size-sm">
                    Toplam: @Model.TotalCount | Sayfa: @Model.PageIndex / @(Math.Max(1, (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize))) | Boyut: @Model.PageSize
                </span>
            </h3>
        </div>
        <div class="card-toolbar">
            <form id="exportXlsxForm" action="Reports/ExportXlsx" method="post" class="d-none">
                @Html.AntiForgeryToken()

                <input type="hidden" name="ReportKey" value="@Model.ReportKey" />
                <input type="hidden" name="PageIndex" value="@Model.PageIndex" />
                <input type="hidden" name="PageSize" value="@Model.PageSize" />
                <input type="hidden" id="ExportAll" name="ExportAll" value="false" />

                @* Parametreleri geri gönder *@
                @foreach (var kv in Model.Parameters)
                {
                    <input type="hidden" name="Parameters[@kv.Key]" value="@kv.Value" />
                }
            </form>
            <button type="button" class="btn btn-sm btn-hover-light-primary" id="btnExportPage">
                <i class="fas fa-file-excel"></i> Excel (Sayfa)
            </button>
            <button type="button" class="btn btn-sm btn-primary" id="btnExportAll">
                <i class="fas fa-file-excel"></i> Excel (Tümü)
            </button>
        </div>
    </div>
    <div class="card-body">
@if (table is null || table.Rows.Count == 0)
{
    <div class="alert alert-info">Kayıt bulunamadı.</div>
}
else
{
  

    <div class="table-responsive">
                <table class="table table-sm table-striped table-hover table-bordered" >
            <thead>
                <tr>
                    @foreach (DataColumn col in table.Columns)
                    {//kt_datatable1
                        <th>@col.ColumnName</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (DataRow row in table.Rows)
                {
                    <tr>
                        @foreach (DataColumn col in table.Columns)
                        {
                            var val = row[col];
                            if (val == DBNull.Value) { val = ""; }

                            if (val is DateTime dt)
                            {
                                <td>@dt.ToString("yyyy-MM-dd HH:mm")</td>
                            }
                            else if (val is decimal dec)
                            {
                                <td>@dec.ToString("N2")</td>
                            }
                            else
                            {
                                <td>@val</td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @await Html.PartialAsync("_Pager", new PagerModel {
        TotalCount = Model.TotalCount,
        PageIndex = Model.PageIndex,
        PageSize = Model.PageSize,
        MaxPagesToShow = 7
    })
}
    </div>
</div>
@section JSSection {
    <script src="js/select2.js?v=7.0.5"></script>
    <script src="~/assets1/plugins/custom/datatables/datatables.bundle.js?v=7.0.5"></script>
    <script src="~/assets1/js/pages/crud/datatables/extensions/buttonsCustom.js?v=7.0.5"></script>

    <script src="~/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="~/vendor/datatables/dataTables.bootstrap4.min.js"></script>
    <script src="~/assets0/js/scripts.bundle.min.js"></script>

    <script>
        const form = document.getElementById('exportXlsxForm');
        document.getElementById('btnExportPage')?.addEventListener('click', function(){
          document.getElementById('ExportAll').value = 'false';
          form?.submit();
        });
        document.getElementById('btnExportAll')?.addEventListener('click', function(){
          document.getElementById('ExportAll').value = 'true';
          // İstersen burada PageSize'ı da büyük bir değere çekebilirsin:
          // form.querySelector('input[name="PageIndex"]').value = '1';
          // form.querySelector('input[name="PageSize"]').value  = '2147483647';
          form?.submit();
        });
    </script>

    <script>

                 

      // Pager linklerine tıklanınca formu aynı parametrelerle yeniden post et
              document.addEventListener('click', function (e) {
                const a = e.target.closest('a.page-link[data-page]');
                if (!a) return;
                e.preventDefault();
                if (a.parentElement.classList.contains('disabled') || a.parentElement.classList.contains('active')) return;
                const page = parseInt(a.dataset.page, 10);
                if (!isFinite(page)) return;
                document.getElementById('PageIndex').value = page;
                document.getElementById('resultForm').submit();
              }, { passive: false });
    </script>
}

